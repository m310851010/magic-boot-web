<div class="full-height-less flex-horizontal">
  <div style="width: 280px">
    <nz-card nzTitle="组织机构" nzSize="small" [nzExtra]="nzExtraTemplate" class="flex-card card-body-less full-height">
      <div class="flex-vertical flex-main">
        <div class="search-box">
          <nz-input-group nzSearch nzSuffixIcon="search">
            <input
              nz-input
              placeholder="请输入关键字搜索"
              [(ngModel)]="searchText"
              (ngModelChange)="onSearchTextChange($event)"
            />
          </nz-input-group>
        </div>

        <div class="flex-main relative">
          <nz-tree
            class="full-overflow"
            style="padding-left: 10px"
            [nzData]="nodes"
            nzShowLine
            nzCheckable
            nzBlockNode
            [nzShowIcon]="false"
            (nzCheckBoxChange)="onCheckBoxChange($event, table)"
          ></nz-tree>
        </div>
      </div>

      <ng-template #nzExtraTemplate>
        <span nz-icon nzType="ellipsis-vertical" class="cursor-pointer" nz-dropdown [nzDropdownMenu]="menu"></span>
      </ng-template>

      <nz-dropdown-menu #menu="nzDropdownMenu">
        <ul nz-menu>
          <li nz-menu-item (click)="onToggleExpandAll(true)">展开全部</li>
          <li nz-menu-item (click)="onToggleExpandAll(false)">折叠全部</li>
        </ul>
      </nz-dropdown-menu>
    </nz-card>
  </div>

  <div class="flex-main">
    <nzx-page>
      <nzx-header>
        <form nz-form [formGroup]="searchForm">
          <ma-form-search [table]="table" [form]="searchForm">
            <formly-form
              [form]="searchForm"
              [fields]="searchFields"
              [model]="searchModel"
              [options]="{ formState: gridOptions }"
            ></formly-form>
          </ma-form-search>
        </form>
      </nzx-header>

      <nzx-content>
        <nzx-table #table [nzxColumns]="columns" api="/system/user/list" [params]="getParams">
          <div title>
            <nz-space>
              <ng-container *auth="'user:save'">
                <button *nzSpaceItem nz-button nzType="primary" (click)="openModal('新建用户', {}, modalTemplate)">
                  <span nz-icon nzType="plus"></span>
                  新建用户
                </button>
              </ng-container>

              <ng-container *auth="'user:delete'">
                <button *nzSpaceItem nz-button nzDanger>
                  <span nz-icon nzType="delete"></span>
                  批量删除
                </button>
              </ng-container>

              <ng-container *auth="'user:import'">
                <button *nzSpaceItem nz-button>
                  <span nz-icon nzType="import"></span>
                  导入
                </button>
              </ng-container>

              <ng-container *auth="'user:export'">
                <button *nzSpaceItem nz-button>
                  <span nz-icon nzType="export"></span>
                  导出
                </button>
              </ng-container>
            </nz-space>
          </div>
          <ng-template named="buttons" let-row>
            <a *auth="'user:save'" (click)="openModal('修改用户', row, modalTemplate)" class="mr-xs">修改</a>
            <a *auth="'user:delete'" (click)="onDeleteClick(row, table)" class="mr-xs">删除</a>
            <a *auth="'user:resetpwd'" (click)="onResetPasswordClick(row)">重置密码</a>
          </ng-template>
          <ng-template named="role" let-row>
            <nz-tag nzColor="processing" *ngFor="let role of row.roleNames">{{ role }}</nz-tag>
          </ng-template>
        </nzx-table>
      </nzx-content>
    </nzx-page>
  </div>
</div>

<ng-template #modalTemplate>
  <form nz-form [formGroup]="modalForm">
    <formly-form
      [form]="modalForm"
      [fields]="modalFields"
      [model]="modalModel"
      [options]="{ formState: { nzGutter: 10, colNzSpan: 12, labelNzFlex: '80px' } }"
    ></formly-form>
  </form>
</ng-template>
